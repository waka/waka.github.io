<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" /><meta content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" name="viewport" /><title>AngularJSのDIの仕組みを追ってみた - yo_waka&#39;s blog</title><link href="/feed.xml" rel="alternate" title="Atom Feed" type="application/atom+xml" /><link href="/assets/images/favicon.ico" rel="icon" type="image/vnd.microsoft.icon" /><link href="/assets/stylesheets/normalize.css" rel="stylesheet" type="text/css" /><link href="/assets/stylesheets/syntax_highlight.css" rel="stylesheet" type="text/css" /><link href="/assets/stylesheets/main.css?1485024912" rel="stylesheet" type="text/css" /></head><body><div class="layout"><header class="header"><h1><a href="/index.html">yo_waka&#39;s blog</a></h1></header><div class="main"><div class="container"><div class="content"><div class="post-date">2014-01-05</div><article class="post"><h1>AngularJSのDIの仕組みを追ってみた</h1>

<p>AngularJS黒魔術のうちの1つ。DI。</p>

<p>コントローラーの引数に$httpなどを指定すると、なぜ何もしなくてもHttpProviderの返り値が入ってくるのか。</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">userControllers</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;userControllers&#39;</span><span class="p">,</span> <span class="p">[]);</span>

<span class="nx">userControllers</span><span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">&#39;UsersCtrl&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$http</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;users/index.json&#39;</span><span class="p">).</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">users</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
<p>これは、定義したコントローラーをインスタンス化する際にannotate関数でDI対象となる引数を取得して、該当するサービスオブジェクトに差し替えているから。</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">invoke</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">self</span><span class="p">,</span> <span class="nx">locals</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">$inject</span> <span class="o">=</span> <span class="nx">annotate</span><span class="p">(</span><span class="nx">fn</span><span class="p">),</span>
      <span class="nx">length</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span>
      <span class="nx">key</span><span class="p">;</span>

  <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">$inject</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">key</span> <span class="o">=</span> <span class="nx">$inject</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">key</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="nx">$injectorMinErr</span><span class="p">(</span><span class="s1">&#39;itkn&#39;</span><span class="p">,</span>
          <span class="s1">&#39;Incorrect injection token! Expected service name as string, got {0}&#39;</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
        <span class="nx">locals</span> <span class="o">&amp;&amp;</span> <span class="nx">locals</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
        <span class="o">?</span> <span class="nx">locals</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        <span class="o">:</span> <span class="nx">getService</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
        <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fn</span><span class="p">.</span><span class="nx">$inject</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fn</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">[</span><span class="nx">length</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>では、annotate関数では何をしているのか。<br>
FunctionオブジェクトをtoStringで文字列化して、引数に当たる文字列を抜き出し、返している。<br>
fn.lengthはその関数が受け取る引数の数を表す。</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">annotate</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">$inject</span><span class="p">,</span>
      <span class="nx">fnText</span><span class="p">,</span>
      <span class="nx">argDecl</span><span class="p">,</span>
      <span class="nx">last</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">fn</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">$inject</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">$inject</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">$inject</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">fn</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fnText</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="nx">STRIP_COMMENTS</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
        <span class="nx">argDecl</span> <span class="o">=</span> <span class="nx">fnText</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">FN_ARGS</span><span class="p">);</span>
        <span class="nx">forEach</span><span class="p">(</span><span class="nx">argDecl</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="nx">FN_ARG_SPLIT</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arg</span><span class="p">){</span>
          <span class="nx">arg</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">FN_ARG</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">all</span><span class="p">,</span> <span class="nx">underscore</span><span class="p">,</span> <span class="nx">name</span><span class="p">){</span>
            <span class="nx">$inject</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">}</span>
      <span class="nx">fn</span><span class="p">.</span><span class="nx">$inject</span> <span class="o">=</span> <span class="nx">$inject</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">$inject</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>上の例の場合、argDecl[1]には&quot;$scope, $http&quot;という文字列が入る。<br>
これをsplitして、getService関数でファクトリ関数の返り値をキャッシュしたプールからオブジェクトを取り出し、コントローラーのコンストラクタに渡して実行する、というわけか。</p>

<p>このキャッシュプールから取り出すキーになるのが&quot;$http&quot;だったり&quot;$routeParams&quot;だったりするので、引数の名前が違うとDIされない。<br>
Angularが用意しているProviderを使いたければ、Angularが中で持っている名前にしないといけないし、module.factoryなどでユーザーが定義したサービスだったら、その名前で指定しないといけない。</p>

<p>また、よく言われるminifyのための注意として、ユーザーが定義するコントローラーやサービスには文字列でも引数を指定しておくというのも納得。<br>
そうしないとminify時に引数名が短縮されてしまうので、DIすべき対象が見つからなくなってしまう。</p>
<div class="highlight"><pre><span class="nx">userControllers</span><span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">&#39;UsersCtrl&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;$scope&#39;</span><span class="p">,</span> <span class="s1">&#39;$http&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$http</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;users/index.json&#39;</span><span class="p">).</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">users</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}]);</span>
</pre></div></article></div></div><div class="profile"><div class="account"><a href="https://twitter.com/yo_waka" target="_blank"><img height="48" src="/assets/images/waka.png" width="48" /></a></div><div class="intro"><a href="https://twitter.com/yo_waka" target="_blank">@yo_waka</a><p>Software Engineer. Joined at freee K.K. since 2013. I like Ruby and JavaScript, but I really like Java.</p></div></div><footer class="footer"><p class="copyright">Copyright &copy; 2013 by <a href="https://twitter.com/yo_waka" target="_blank">@yo_waka</a></p></footer></div></div></body></html>