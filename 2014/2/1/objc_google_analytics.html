<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" /><meta content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" name="viewport" /><title>iOSアプリの全てのビューコントローラーにGoogleAnalyticsを一括で設定する - yo_waka&#39;s blog</title><link href="/feed.xml" rel="alternate" title="Atom Feed" type="application/atom+xml" /><link href="/assets/images/favicon.ico" rel="icon" type="image/vnd.microsoft.icon" /><link href="/assets/stylesheets/normalize.css" rel="stylesheet" type="text/css" /><link href="/assets/stylesheets/syntax_highlight.css" rel="stylesheet" type="text/css" /><link href="/assets/stylesheets/main.css?1485024912" rel="stylesheet" type="text/css" /></head><body><div class="layout"><header class="header"><h1><a href="/index.html">yo_waka&#39;s blog</a></h1></header><div class="main"><div class="container"><div class="content"><div class="post-date">2014-02-01</div><article class="post"><h1>iOSアプリの全てのビューコントローラーにGoogleAnalyticsを一括で設定する</h1>

<p>今作っているアプリで、改善のためにどれくらい画面が使われているか知りたかったので、GoogleAnalyticsを入れたときのメモ。</p>

<p>GoogleAnalyticsはご存知みんな知っているアクセス解析ツール。<br>
iOS用にもSDKが公開されていて、CocoaPodsを使っていればpod installで簡単に入れられる。</p>
<div class="highlight"><pre>pod <span class="s1">&#39;GoogleAnalytics-iOS-SDK&#39;</span>, <span class="s1">&#39;~&gt; 3.0&#39;</span>
</pre></div>
<p>画面の閲覧回数を取るためには、2つやり方がある。</p>

<p>1つは、GAITrackedViewControllerクラスを継承したUIViewControllerを作る。<br>
viewDidLoadなどでscreenNameに画面名をセットしておくと、viewDidAppearで自動でトラッキングリクエストが送信される。</p>
<div class="highlight"><pre><span class="k">@interface</span> <span class="nc">SampleViewController</span> : <span class="nc">GAITrackedViewController</span>
<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">SampleViewController</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span>
<span class="p">{</span>
    <span class="n">self</span><span class="p">.</span><span class="n">screenName</span> <span class="o">=</span> <span class="s">@&quot;画面名&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">end</span>
</pre></div>
<p>もう1つは、ビューコントローラーのviewDidLoadかviewDidAppearで、GAITrackerクラスを使って画面名を送ってやるやり方。<br>
こっちはWebブラウザ版の使い方に近い。<br>
UITableViewControllerなどUIViewControllerのサブクラスを使っている場合は、こっちでやるしかない。</p>
<div class="highlight"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidAppear</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="n">viewDidAppear</span><span class="p">];</span>

    <span class="kt">id</span> <span class="n">tracker</span> <span class="o">=</span> <span class="p">[[</span><span class="n">GAI</span> <span class="n">sharedInstance</span><span class="p">]</span> <span class="n">defaultTracker</span><span class="p">];</span>
    <span class="p">[</span><span class="n">tracker</span> <span class="n">set</span><span class="o">:</span><span class="n">kGAIScreenName</span> <span class="n">value</span><span class="o">:</span><span class="s">@&quot;画面名&quot;</span><span class="p">];</span>
    <span class="p">[</span><span class="n">tracker</span> <span class="n">send</span><span class="o">:</span><span class="p">[[</span><span class="n">GAIDictionaryBuilder</span> <span class="n">createAppView</span><span class="p">]</span> <span class="n">build</span><span class="p">]];</span>
<span class="p">}</span>
</pre></div>
<p>つまり、UITableViewControllerをふんだんに使っていたり、UIViewControllerを継承したベースクラスを作っていると、1つ1つのビューに同じ処理を書かないといけない。<br>
これは絶対入れるの忘れそうなのでなんとかしたい。。。と思って調べてみた。</p>

<p>Objective-CにはMethod Swizzlingという、すでに実装されているクラスのメソッドを自前のメソッドに入れ替えるやり方が用意されているらしい。<br>
&quot;objc/runtime.h&quot;が提供している、method_exchangeImplementations関数を使えばクラスメソッドの入れ替えが可能になる。</p>

<p>これを使ってUIViewControllerのメソッドを入れ替えれば各画面ごとにアナリティクス処理を書かずに済みそう。<br>
つまり、UIViewControllerのカテゴリ拡張を作って、viewDidAppearをGATrackerの処理を追加してものに入れ替える関数を用意する。<br>
画面名には「NSStringFromClass([self class])」でクラス名を自動でセットしてやる。</p>
<div class="highlight"><pre><span class="cp">#import &lt;objc/runtime.h&gt;</span>

<span class="k">@implementation</span> <span class="nc">UIViewController</span> <span class="nl">(GAInject)</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">replacedViewDidAppear:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span>
<span class="p">{</span>
    <span class="c1">// 元のメソッド（名前は既に置き換わっているので注意）を呼び出す</span>
    <span class="p">[</span><span class="n">self</span> <span class="n">replacedViewDidAppear</span><span class="o">:</span><span class="n">animated</span><span class="p">];</span>

    <span class="p">[[</span><span class="n">GAI</span> <span class="n">sharedInstance</span><span class="p">].</span><span class="n">defaultTracker</span> <span class="n">set</span><span class="o">:</span><span class="n">kGAIScreenName</span> <span class="n">value</span><span class="o">:</span><span class="n">NSStringFromClass</span><span class="p">([</span><span class="n">self</span> <span class="n">class</span><span class="p">])];</span>
    <span class="p">[[</span><span class="n">GAI</span> <span class="n">sharedInstance</span><span class="p">].</span><span class="n">defaultTracker</span> <span class="n">send</span><span class="o">:</span><span class="p">[[</span><span class="n">GAIDictionaryBuilder</span> <span class="n">createAppView</span><span class="p">]</span> <span class="n">build</span><span class="p">]];</span>
<span class="p">}</span>

<span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">exchangeMethod</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">self</span> <span class="n">exchangeInstanceMethodFrom</span><span class="o">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">viewDidAppear</span><span class="o">:</span><span class="p">)</span> <span class="n">to</span><span class="o">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">replacedViewDidAppear</span><span class="o">:</span><span class="p">)];</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> メソッドの入れ替え</span>
<span class="cm">  */</span>
<span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">exchangeInstanceMethodFrom:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">from</span> <span class="nf">to:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">to</span>
<span class="p">{</span>
    <span class="n">Method</span> <span class="n">fromMethod</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">from</span><span class="p">);</span>
    <span class="n">Method</span> <span class="n">toMethod</span>   <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">to</span><span class="p">);</span>
    <span class="n">method_exchangeImplementations</span><span class="p">(</span><span class="n">fromMethod</span><span class="p">,</span> <span class="n">toMethod</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">@end</span>
</pre></div>
<p>AppDelegateでこいつを呼び出してUIViewControllerのviewDidAppear関数を入れ替える。</p>
<div class="highlight"><pre><span class="cp">#import &quot;UIViewController+GAInject.h&quot;</span>

<span class="k">@implementation</span> <span class="nc">SampleAppDelegate</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didFinishLaunchingWithOptions:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">launchOptions</span>
<span class="p">{</span>
    <span class="c1">// UIViewControllerのメソッド差し替え</span>
    <span class="p">[</span><span class="n">UIViewController</span> <span class="n">exchangeMethod</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>
</pre></div>
<p>これで、UIViewControllerを継承しているUITableViewControllerや自作ビューコントローラーでも、自動でトラッキング処理が走るようになります。<br>
method_exchangeimplementations、Rubyのalias_method感覚で使えるヒッジョーに面白い仕組みですが、そのクラスと子クラスすべての挙動が変わるので使いどころには要注意ですね。</p>
</article></div></div><div class="profile"><div class="account"><a href="https://twitter.com/yo_waka" target="_blank"><img height="48" src="/assets/images/waka.png" width="48" /></a></div><div class="intro"><a href="https://twitter.com/yo_waka" target="_blank">@yo_waka</a><p>Software Engineer. Joined at freee K.K. since 2013. I like Ruby and JavaScript, but I really like Java.</p></div></div><footer class="footer"><p class="copyright">Copyright &copy; 2013 by <a href="https://twitter.com/yo_waka" target="_blank">@yo_waka</a></p></footer></div></div></body></html>